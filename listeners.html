<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KUAA Listeners Map</title>

    <!-- Leaflet CSS + Leaflet.curve for arcs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.curve/leaflet.curve.min.js"></script>

    <style>
        :root {
            --bg-dark: #111;
            --bg-light: #f0f0f0;
            --text-dark: #eee;
            --text-light: #222;
            --accent-color: #ff6237;
            --hot-pink: #ff3366;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background: var(--bg-dark);
            color: var(--text-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        body.light-theme {
            background: var(--bg-light);
            color: var(--text-light);
        }

        #sidebar {
            width: 350px;
            background: var(--bg-dark);
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid #333;
            overflow-y: auto;
            transition: background 0.3s, color 0.3s;
        }

        body.light-theme #sidebar {
            background: var(--bg-light);
            color: var(--text-light);
            border-color: #ccc;
        }

        #sidebar h2 {
            margin-top: 0;
            color: var(--accent-color);
        }

        #map {
            flex-grow: 1;
        }

        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            background: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
        }

        #themeToggle {
            margin-top: 20px;
            padding: 10px 15px;
            background: var(--accent-color);
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 100%;
            font-size: 14px;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 6px;
            text-align: left;
        }

        th {
            color: #888;
        }

        td:last-child {
            color: var(--hot-pink);
        }

        #listenerTable {
            color: #ccc;
        }

        .stats {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-box {
            background: var(--hot-pink);
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-dark);
            color: var(--text-dark);
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
        }

        body.light-theme .leaflet-popup-content-wrapper {
            background: var(--bg-light);
            color: var(--text-light);
        }

        .leaflet-popup-tip {
            background: var(--bg-dark);
        }

        body.light-theme .leaflet-popup-tip {
            background: var(--bg-light);
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <a href="/" class="nav-link">‚üµ Back to Home</a>
        <h2>Listener Stats</h2>

        <div class="stats">
            <div class="stat-box">üì° <span id="listenerCount">0</span></div>
            <div class="stat-box">‚ù§Ô∏è <span id="favoritesCount">94</span></div>
        </div>

        <div style="max-height: 350px; overflow-y: auto; border-top: 1px solid #333;">
            <table>
                <thead>
                    <tr>
                        <th>üì∂ City</th>
                        <th>Region</th>
                        <th>Country</th>
                    </tr>
                </thead>
                <tbody id="listenerTable"></tbody>
            </table>
        </div>

        <button id="themeToggle">Toggle Light/Dark Theme</button>
    </div>

    <div id="map"></div>

    <script>
        const slcCoords = [40.7608, -111.8910];
        const map = L.map('map').setView(slcCoords, 3);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB',
        }).addTo(map);

        // Theme Toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
        });

        // DOM for stats + table
        const listenerCountEl = document.getElementById('listenerCount');
        const tableBody = document.getElementById('listenerTable');

        // Utility: draw curved arc from SLC
        function drawAnimatedArc(start, end) {
            const latlngs = [
                'M', start,
                'Q', [
                    (start[0] + end[0]) / 2 + 10,
                    (start[1] + end[1]) / 2
                ],
                end
            ];

            const arc = L.curve(latlngs, {
                color: '#ff6237',
                weight: 2,
                opacity: 0,
                dashArray: '5 10',
            }).addTo(map);

            let opacity = 0;
            const interval = setInterval(() => {
                opacity += 0.05;
                arc.setStyle({ opacity });
                if (opacity >= 1) clearInterval(interval);
            }, 50);
        }

        // Fetch and highlight current visitor
        fetch('/.netlify/functions/getLocation')
            .then(res => res.json())
            .then(visitor => {
                const coords = [visitor.lat, visitor.lon];
                L.marker(coords)
                    .addTo(map)
                    .bindPopup(`You are a listener from ${visitor.city}, ${visitor.country}!`)
                    .openPopup();

                map.flyTo(coords, 4, { duration: 2 });
                drawAnimatedArc(slcCoords, coords);
            });

        // Fetch all logged visitors
        fetch('/.netlify/functions/getLogFromGitHub')
            .then(res => res.json())
            .then(data => {
                listenerCountEl.textContent = data.length;

                data.forEach(visitor => {
                    const coords = [visitor.lat, visitor.lon];
                    drawAnimatedArc(slcCoords, coords);

                    L.circleMarker(coords, {
                        radius: 5,
                        color: '#ff6237',
                        fillOpacity: 0.7,
                    })
                        .addTo(map)
                        .bindPopup(`Listener from ${visitor.city}, ${visitor.country}`);

                    // Add to table
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>üì° ${visitor.city || 'Unknown'}</td>
            <td>${visitor.region || ''}</td>
            <td>${visitor.country || ''}</td>
          `;
                    tableBody.appendChild(row);
                });
            });
    </script>
</body>

</html>