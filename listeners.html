<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KUAA Listeners Map</title>
    <style>
        body {
            margin: 0;
            background-color: #111;
            color: white;
            font-family: sans-serif;
        }

        #globeViz {
            width: 100vw;
            height: 100vh;
        }

        .location-label {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="globeViz"></div>

    <div id="locationDisplay" class="location-label">Fetching your location...</div>

    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/three-globe"></script>

    <script>
        // --- Configuration ---
        const SLC_COORDS = { lat: 40.7608, lng: -111.8910 };

        // --- Globe Initialization ---
        const globe = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('rgba(0,0,0,0)')
            .arcColor(() => '#ff6237') // KUAA-like red/orange color
            .arcDashLength(0.4)
            .arcDashGap(1)
            .arcDashAnimateTime(1500)
            .arcStroke(0.5);

        // Set camera position
        globe.pointOfView({ lat: SLC_COORDS.lat, lng: SLC_COORDS.lng, altitude: 2 });


        // --- Data Fetching and Visualization ---
        async function fetchAndDrawVisitor() {
            try {
                // 1. Fetch data from our serverless function
                const response = await fetch('/.netlify/functions/getLocation');
                if (!response.ok) throw new Error('Could not fetch location');

                const visitor = await response.json();

                // 2. Display the fetched location text
                const display = document.getElementById('locationDisplay');
                display.textContent = `A listener is tuning in from ${visitor.city}, ${visitor.country}!`;

                // 3. Draw the arc on the globe
                const arcData = [{
                    startLat: SLC_COORDS.lat,
                    startLng: SLC_COORDS.lng,
                    endLat: visitor.lat,
                    endLng: visitor.lon,
                }];

                globe.arcsData(arcData);

            } catch (error) {
                console.error('Error fetching visitor data:', error);
                const display = document.getElementById('locationDisplay');
                display.textContent = 'Could not determine your location.';
            }
        }

        // Run the function when the page loads
        fetchAndDrawVisitor();

    </script>
</body>

</html>